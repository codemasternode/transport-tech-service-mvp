{"version":3,"sources":["../../src/queries/searchMulti.js"],"names":["PI","Math","start","Date","setHours","end","getTime","db","vehicles","aggregate","$match","type","$lookup","from","vehicleId","pipeline","$expr","$in","$addFields","distance","$let","vars","lat2","lng2","lat1","lng1","$multiply","$atan2","$sqrt","$sum","$sin","$divide","$subtract","$cos","as","$unwind","$sort","fuel","$and","$eq","$gte","$lt","$project","$or","$lte","fullCost","waitingCost","$cond","$ne","$group","_id","$push"],"mappings":"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","sourcesContent":["const PI = Math.PI;\nconst start = new Date();\nstart.setHours(0, 0, 0, 0);\n\nconst end = new Date(start.getTime());\nend.setHours(23, 59, 59, 999);\n\ndb.vehicles.aggregate([\n  {\n    $match: {\n      type: \"Ch≈Çodnia\"\n    }\n  },\n  {\n    $lookup: {\n      from: \"companybases\",\n      let: {\n        vehicleId: \"$_id\"\n      },\n      pipeline: [\n        {\n          $match: {\n            $expr: { $in: [\"$$vehicleId\", \"$vehicles._id\"] }\n          }\n        },\n        {\n          $addFields: {\n            distance: {\n              $let: {\n                vars: {\n                  lat2: \"$location.lat\",\n                  lng2: \"$location.lng\",\n                  lat1: 50.059515,\n                  lng1: 19.92246\n                },\n                in: {\n                  $multiply: [\n                    6371,\n                    {\n                      $multiply: [\n                        2,\n                        {\n                          $atan2: [\n                            {\n                              $sqrt: {\n                                $sum: [\n                                  {\n                                    $multiply: [\n                                      {\n                                        $sin: {\n                                          $divide: [\n                                            {\n                                              $divide: [\n                                                {\n                                                  $multiply: [\n                                                    {\n                                                      $subtract: [\n                                                        \"$$lat2\",\n                                                        \"$$lat1\"\n                                                      ] //[lat2, lat1]\n                                                    },\n                                                    PI\n                                                  ]\n                                                },\n                                                180\n                                              ]\n                                            },\n                                            2\n                                          ]\n                                        }\n                                      },\n                                      {\n                                        $sin: {\n                                          $divide: [\n                                            {\n                                              $divide: [\n                                                {\n                                                  $multiply: [\n                                                    {\n                                                      $subtract: [\n                                                        \"$$lat2\",\n                                                        \"$$lat1\"\n                                                      ] //[lat2, lat1]\n                                                    },\n                                                    PI\n                                                  ]\n                                                },\n                                                180\n                                              ]\n                                            },\n                                            2\n                                          ]\n                                        }\n                                      }\n                                    ]\n                                  },\n                                  {\n                                    $multiply: [\n                                      {\n                                        $multiply: [\n                                          {\n                                            $sin: {\n                                              $divide: [\n                                                {\n                                                  $divide: [\n                                                    {\n                                                      $multiply: [\n                                                        {\n                                                          $subtract: [\n                                                            \"$$lng2\",\n                                                            \"$$lng1\"\n                                                          ] //[lon2, lon1]\n                                                        },\n                                                        PI\n                                                      ]\n                                                    },\n                                                    180\n                                                  ]\n                                                },\n                                                2\n                                              ]\n                                            }\n                                          },\n                                          {\n                                            $sin: {\n                                              $divide: [\n                                                {\n                                                  $divide: [\n                                                    {\n                                                      $multiply: [\n                                                        {\n                                                          $subtract: [\n                                                            \"$$lng2\",\n                                                            \"$$lng1\"\n                                                          ] //[lon2, lon1]\n                                                        },\n                                                        PI\n                                                      ]\n                                                    },\n                                                    180\n                                                  ]\n                                                },\n                                                2\n                                              ]\n                                            }\n                                          }\n                                        ]\n                                      },\n                                      {\n                                        $multiply: [\n                                          {\n                                            $cos: {\n                                              $divide: [\n                                                {\n                                                  $multiply: [\n                                                    \"$$lat1\", //lat1\n                                                    PI\n                                                  ]\n                                                },\n                                                180\n                                              ]\n                                            }\n                                          },\n                                          {\n                                            $cos: {\n                                              $divide: [\n                                                {\n                                                  $multiply: [\n                                                    \"$$lat2\", //lat2\n                                                    PI\n                                                  ]\n                                                },\n                                                180\n                                              ]\n                                            }\n                                          }\n                                        ]\n                                      }\n                                    ]\n                                  }\n                                ]\n                              }\n                            },\n                            {\n                              $sqrt: {\n                                $subtract: [\n                                  1,\n                                  {\n                                    $sum: [\n                                      {\n                                        $multiply: [\n                                          {\n                                            $sin: {\n                                              $divide: [\n                                                {\n                                                  $divide: [\n                                                    {\n                                                      $multiply: [\n                                                        {\n                                                          $subtract: [\n                                                            \"$$lat2\",\n                                                            \"$$lat1\"\n                                                          ] //[lat2, lat1]\n                                                        },\n                                                        PI\n                                                      ]\n                                                    },\n                                                    180\n                                                  ]\n                                                },\n                                                2\n                                              ]\n                                            }\n                                          },\n                                          {\n                                            $sin: {\n                                              $divide: [\n                                                {\n                                                  $divide: [\n                                                    {\n                                                      $multiply: [\n                                                        {\n                                                          $subtract: [\n                                                            \"$$lat2\",\n                                                            \"$$lat1\"\n                                                          ] //[lat2, lat1]\n                                                        },\n                                                        PI\n                                                      ]\n                                                    },\n                                                    180\n                                                  ]\n                                                },\n                                                2\n                                              ]\n                                            }\n                                          }\n                                        ]\n                                      },\n                                      {\n                                        $multiply: [\n                                          {\n                                            $multiply: [\n                                              {\n                                                $sin: {\n                                                  $divide: [\n                                                    {\n                                                      $divide: [\n                                                        {\n                                                          $multiply: [\n                                                            {\n                                                              $subtract: [\n                                                                \"$$lng2\",\n                                                                \"$$lng1\"\n                                                              ] //[lon2, lon1]\n                                                            },\n                                                            PI\n                                                          ]\n                                                        },\n                                                        180\n                                                      ]\n                                                    },\n                                                    2\n                                                  ]\n                                                }\n                                              },\n                                              {\n                                                $sin: {\n                                                  $divide: [\n                                                    {\n                                                      $divide: [\n                                                        {\n                                                          $multiply: [\n                                                            {\n                                                              $subtract: [\n                                                                \"$$lng2\",\n                                                                \"$$lng1\"\n                                                              ] //[lon2, lon1]\n                                                            },\n                                                            PI\n                                                          ]\n                                                        },\n                                                        180\n                                                      ]\n                                                    },\n                                                    2\n                                                  ]\n                                                }\n                                              }\n                                            ]\n                                          },\n                                          {\n                                            $multiply: [\n                                              {\n                                                $cos: {\n                                                  $divide: [\n                                                    {\n                                                      $multiply: [\n                                                        \"$$lat1\", //lat1\n                                                        PI\n                                                      ]\n                                                    },\n                                                    180\n                                                  ]\n                                                }\n                                              },\n                                              {\n                                                $cos: {\n                                                  $divide: [\n                                                    {\n                                                      $multiply: [\n                                                        \"$$lat2\", //lat2\n                                                        PI\n                                                      ]\n                                                    },\n                                                    180\n                                                  ]\n                                                }\n                                              }\n                                            ]\n                                          }\n                                        ]\n                                      }\n                                    ]\n                                  }\n                                ]\n                              }\n                            }\n                          ]\n                        }\n                      ]\n                    }\n                  ]\n                }\n              }\n            }\n          }\n        }\n      ],\n      as: \"companyBases\"\n    }\n  },\n  {\n    $unwind: \"$companyBases\"\n  },\n  {\n    $sort: {\n      \"companyBases.distance\": 1\n    }\n  },\n  {\n    $lookup: {\n      from: \"fuels\",\n      let: {\n        fuel: \"$fuel\"\n      },\n      pipeline: [\n        {\n          $match: {\n            $expr: {\n              $and: [\n                { $eq: [\"$name\", \"$$fuel\"] },\n                {\n                  $and: [{ $gte: [\"$date\", start] }, { $lt: [\"$date\", end] }]\n                }\n              ]\n            }\n          }\n        }\n      ],\n      as: \"fuel\"\n    }\n  },\n  {\n    $unwind: \"$fuel\"\n  },\n  {\n    $lookup: {\n      from: \"companies\",\n      let: {\n        vehicleId: \"$_id\"\n      },\n      pipeline: [\n        {\n          $unwind: \"$companyBases\"\n        },\n        {\n          $match: {\n            $expr: {\n              $in: [\"$$vehicleId\", \"$companyBases.vehicles._id\"]\n            }\n          }\n        }\n      ],\n      as: \"company\"\n    }\n  },\n  {\n    $unwind: \"$company\"\n  },\n  {\n    $project: {\n      \"company.companyBases\": 0,\n      \"company.staticCosts\": 0,\n      \"company.workers\": 0,\n      \"companyBases.vehicles\": 0\n    }\n  },\n  {\n    $addFields: {\n      distance: {\n        $sum: [950, \"$companyBases.distance\"]\n      }\n    }\n  },\n  {\n    $match: {\n      $expr: {\n        $and: [\n          {\n            $or: [\n              {\n                $eq: [\"$range.minRange\", null]\n              },\n              {\n                $lte: [\"$range.minRange\", \"$distance\"]\n              }\n            ]\n          },\n          {\n            $or: [\n              {\n                $eq: [\"$range.maxRange\", null]\n              },\n              {\n                $gte: [\"$range.maxRange\", \"$distance\"]\n              }\n            ]\n          }\n        ]\n      }\n    }\n  },\n  {\n    $addFields: {\n      fullCost: {\n        $multiply: [\n          {\n            $divide: [\n              {\n                $sum: [100, \"$company.margin\"]\n              },\n              100\n            ]\n          },\n          {\n            $sum: [\n              {\n                $divide: [\n                  {\n                    $multiply: [\n                      {\n                        $multiply: [\n                          {\n                            $multiply: [\n                              \"$distance\",\n                              {\n                                $divide: [\n                                  {\n                                    $sum: [100, \"$blankJourneys\"]\n                                  },\n                                  100\n                                ]\n                              }\n                            ]\n                          },\n                          \"$fuel.price\"\n                        ]\n                      },\n                      \"$combustion\"\n                    ]\n                  },\n                  100\n                ]\n              },\n\n              {\n                $sum: [\n                  {\n                    $multiply: [\n                      {\n                        $divide: [\n                          {\n                            $multiply: [\n                              \"$valueOfTruck\",\n                              {\n                                $divide: [\"$deprecationPerYear\", 100]\n                              }\n                            ]\n                          },\n                          12\n                        ]\n                      },\n                      {\n                        $divide: [\"$distance\", \"$averageDistancePerMonth\"]\n                      }\n                    ]\n                  },\n                  {\n                    $multiply: [\n                      {\n                        $divide: [\"$distance\", \"$company.sumAvgKmPerMonth\"]\n                      },\n                      \"$company.sumCostsPerMonth\"\n                    ]\n                  }\n                ]\n              }\n            ]\n          }\n        ]\n      }\n    }\n  },\n  {\n    $addFields: {\n      waitingCost: {\n        $multiply: [\n          {\n            $subtract: [12, \"$waitingTimeParams.maxFreeTime\"]\n          },\n          \"$waitingTimeParams.pricePerHourWaiting\"\n        ]\n      }\n    }\n  },\n  {\n    $addFields: {\n      waitingCost: {\n        $cond: [\n          {\n            $lt: [\"$waitingCost\", 0]\n          },\n          0,\n          \"$waitingCost\"\n        ]\n      }\n    }\n  },\n  {\n    $match: {\n      waitingCost: {\n        $ne: null\n      }\n    }\n  },\n  {\n    $addFields: {\n      fullCost: {\n        $sum: [\"$fullCost\", \"$waitingCost\"]\n      }\n    }\n  },\n  {\n    $sort: {\n      fullCost: 1\n    }\n  },\n  {\n    $group: {\n      _id: \"$company._id\",\n      vehicles: {\n        $push: \"$$ROOT\"\n      }\n    }\n  }\n]);\n"],"file":"searchMulti.js"}